<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title></title>
	<meta charset="utf-8" />
</head>
<body>
<script>

  (function () {
    var nextGuid = 1;
    this.addEvent = function (elem, type, fn) {
      /// <summary> 綁定事件處理者 IE9前 相容</summary>
      var data = getData(elem);

      if (!data.handlers)
        data.handlers = {};

      if (!data.handlers[type])
        data.handlers[type] = [];

      if (!fn.guid)
        fn.guid = nextGuid++;

      data.handlers[type].push(fn);

      if (!data.dispatcher) {
        data.disabled = false;
        data.dispatcher = function (event) {

          if (data.disabled) return;
          
          event = fixEvent(event);
          

          var handlers = data.handlers[event.type];
          if (handlers) {
            for (var n = 0; n < handlers.length; n++)
              handlers[n].call(elem, event);
          }
        };//dispatcher
      }

      if (data.handlers[type].length == 1) {
        if (document.addEventListener)
          elem.addEventListener(type, data.dispatcher, false);
        else if (document.attachEvent)
          elem.addtachEvent("on" + type, data.dispatcher);
      }
    }

    this.removeEvent = function (elem, type, fn) {
      var data = getData(elem);
      if (!data.handlers) return;

      var removeType = function (t) {
        data.handlers[t] = [];
        tidyUp(elem, t);
      };

      if (!type) {
        for (var t in data.handlers) removeType(t);
        return;
      }

      var handlers = data.handlers[type];
      if (!handlers) return;

      if (!fn) {
        removeType(type);
        return;
      }

      if ( fn.guid){
        for (var n = 0; n < handlers.length; n++) {
          if (handlers[n].guid === fn.guid)
            handlers.splice(n--, 1);
        }
      }
      tidyUp(elem, type);
    };

    this.triggerEvent = function triggerEvent(elem, event) {
      /// <summary> 參照 page366 </summary>      
      var elemData = getData(elem);
      var parent = elem.parentNode || elem.ownerDocument;

      if (typeof event === "string")
        event = { type: event, target: elem };

      event = fixEvent(event);

      if (elemData.dispatcher)
        elemData.dispatcher.call(elem, event);

      if (parent && !event.isPropagationStopped())
        triggerEvent(parent, event);
      else if (!parent && !event.isDefaultPrevented()) {
        var targetData = getData(event.target);
        if (event.target[event.type]) {
          targetData.disabled = true;
          event.target[event.type]();
          targetData.disabled = false;
        }
      }
    };

    this.isEventSupported = function isEventSupported(eventName) {
      /// <summary> 參照374 頁</summary>

      var element = document.createElement('div');
      var isSupported;

      eventName = 'on' + eventName;
      isSupported = (eventName in element);

      if (!isSupported) {
        element.setAttribute(eventName, 'return;');
        isSupported = typeof element[eventName] == 'function';
      }

      element = null;

      return isSupported;
    };


  })();
  

  

  function tidyUp(elem, type) {
    /// <summary> 相對於 addEvent, 此為取消 event </summary>

    function isEmpty(object) {
      // <summary> 偵測空物件 </summary>
      for (var prop in object) {
        return false;
      }
      return true;
    }

    var data = getData(elem);

    if ( data.handlers[type].length === 0 )
    {
      delete data.handlers[type];

      if (document.removeEventListener)
        elem.removeEventListener(type, data.dispatcher, false);
      else if (document.detachEvent)
        elem.detachEvent("on" + type, data.dispatcher);
    }

    if (isEmpty(data.handlers)) {
      delete data.handlers;
      delete data.dispatcher;
    }

    if (isEmpty(data)) 
      removeData(elem);
  }

	//if ( document.addEventListener )
	//{
	//	this.addEvent = function addEvent(elem, type, fn) {
	//		elem.addEventListener(type, fn, false);
	//		return fn;
	//	};

	//	this.removeEvent = function removeEvent(elem, type, fn) {
	//		elem.removeEventListener(type, fn, false);
	//	};
	//}
	//else if ( document.attachEvent) 
	//{
	//	this.addEvent = function addEvent(elem, type, fn) {
	//		var bound = function () { return fn.apply(elem, arguments); }
	//		elem.attachEvent("on" + type, bound);
	//		return bound;
	//	};
	//	this.removeEvent = function removeEvent(elem, type, fn) {
	//		elem.detachEvent("on" + type, fn);
	//	};
	//}

	function fixEvent(event) {

	  // 預定定義常用函鄉
	  function returnTrue() { return true; }
	  function returnFalse() { return false; }

	  if (!event || !event.stopPropagation) {
	    var old = event || window.event;

	    // 複製舊物件,
	    event = {};
	    for (var prop in old)
	      event[prop] = old[prop];

	    // 事件發生在這個元素身上
	    if (!event.target)
	      event.target = event.srcElement || document; // IE 存到 srcElement, 移到 target

	    // 其它元素哪一個與此事件相關
	    event.relatedTarget = event.fromElement === event.target ?
        event.toElement :
        event.fromElement;

	    // 停止browser 預設動作
	    event.preventDefault = function () {
	      event.returnValue = false;
	      event.isDefaultPrevented = returnTrue;
	    };

	    event.isDefaultPrevented = returnFalse;

	    // 停止事件繼續傳
	    event.stopPropagation = function () {
	      event.cancelable = true;
	      event.isPropagationStopped = returnTrue;
	    };

	    event.isPropagationStopped = returnFalse;

	    // 停止事件繼續傳, 並執行其他處理者
	    event.stopImmediatePropagation = function () {
	      this.isImmediatePropagationStopped = returnTrue;
	      this.stopPropagation();
	    };
	    event.isImmediatePropagationStopped = returnFalse;

	    // 處理滑鼠位置
	    if ( event.clientX != null )
	    {
	      var doc = document.documentElement, body = document.body;

	      event.pageX = event.clientX +
          (doc && doc.scrollLeft || body && body.scrollLeft || 0) -
          (doc && doc.clientLeft || body && body.clientLeft || 0);
	      event.pageY = event.clientY +
          (doc && doc.scrollTop || body && body.scrollTop || 0) -
          (doc && doc.clientTop || body && body.clientTop || 0);
	    }

	    // 處理按鍵
	    event.which = event.charCode || event.keyCode;

	    // 修正滑鼠點擊按鈕;
	    // 0 左 ; 1 中 2 右
	    if ( event.button != null )
	    {
	      event.button = (event.button & 1 ? 0 : (event.button & 4 ? 1 : (event.button & 2 ? 2 : 0)));
	    }
	  }

	  return event;
	}

  (function () {
    // <summary> 事件集中管理 </summary>

    var cache = {},
      guidCounter = 1,
      expando = "data" + (new Date).getTime();

    this.getData = function (elem) {
      var guid = elem[expando];
      if (!guid) {
        guid = elem[expando] = guidCounter++;
        cache[guid] = {};
      }
      return cache[guid];
    };

    this.removeData = function (elem) {
      var guid = elem[expando];
      if (!guid) return;
      delete cache[guid];
      try{
        delete elem[expando];
      }
      catch (e) {
        if (elem.removeAttribute) {
          elem.removeAttribute(expando);
        }
      }
    };
	})();

  
  //// demo 1
  //  addEvent(window, "load", function () {
  //  	var elems = document.getElementsByTagName("div");
  //  	for(var i=0;i<elems.length;++i)
  //  		(function (elem) {
  //  			var handler = addEvent(elem, "click", function () {
  //  				this.style.backgroundColor = this.style.backgroundColor == '' ? 'green' : '';
  //  				removeEvent(elem, 'click', handler);
  //  			});
  //  		})(elems[i]);
  //  });

  //// demo2
  //addEvent(window, "load", function () {
  //  var elems = document.getElementsByTagName("div");

  //  for (var i = 0; i < elems.length; i++) {
  //    (function (elem) {
  //      addEvent(elem, "mouseover", function handler(e) {
  //        this.style.backgroundColor = "red";
  //      });
  //      addEvent(elem, "click", function handler(e) {
  //        this.style.backgroundColor = "green";
  //        removeEvent(elem, "click", handler);
  //      });
  //    })(elems[i]);
  //  }
  //});

  addEvent(window, 'load', function () {

    var button = document.getElementById('clickMe');

    function performAjaxOp(target) {
      triggerEvent(target, 'ajax-start');
      window.setTimeout(function () {
        triggerEvent(target, 'ajax-complete');
      }, 5000);
    }

    addEvent(button, 'click', function () {
      performAjaxOp(this);
    });

    var body = document.getElementsByTagName('body')[0];
    addEvent(body, 'ajax-start', function (e) {
      console.log('ajax-start');
    });
    addEvent(body, 'ajax-complete', function (e) {
      console.log('ajax-complete');
    });

  });

</script>
	<div title="click once">123</div>
	<div title="mouse over">456</div>
  <div title="many times">789</div>

  <button type="button" id="clickMe">Start</button>
  <div id="re1" style="width:200px;height:200px"></div>
</body>
</html>
