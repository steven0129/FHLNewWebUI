<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta property="og:title" content="信望爱圣经工具"/>
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://bkbible.fhl.net/~sean/bible/index.html"/>
    <meta property="og:image" content="images/FHLLOGO.png"/>
    <meta property="og:site_name" content="FHL信望爱圣经工具"/>
    <meta property="og:description" content="" />


    <title>信望爱圣经工具</title>
    <link rel="shortcut icon" href="images/FHLLOGO.ico" type="image/x-icon"/> 

    <link rel="stylesheet" href="./libs/fhl.css" />
    <link rel="stylesheet" href="./libs/icons/css/font-awesome.css" />

    <!--2015.09.02(三) snow add. React lib-->
    <script src="libs/react/react-0.13.1.min.js"></script>
    <script src="libs/react/react-with-addons-0.13.1.min.js"></script>
    <script src="./libs/jquery-1.11.3.js"></script>
    <script src="./libs/xml2json.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <script src="./libs/jquery.hotkeys.js"></script>
    <script src="bible_audio_api/audiobible_api.js"></script>
    <!-- 2015.09.24(四) snow add. obphp lib -->
    <link href="ob_api/ob_api.css" rel="stylesheet" />
    <link href="ob_api/ob_table.css" rel="stylesheet" />
    <script src="ob_api/obphp.js"></script>
    <!--[if IE]>
    <link rel="stylesheet" href="./libs/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.js"></script>

    <!--<script src="https://fb.me/react-0.13.3.min.js"></script>
    <script src="https://fb.me/react-with-addons-0.13.3.min.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>-->
<script>

var pageState;
var currentSWVer="1.0";
var isfirstob; // ob 典藏用
function setPageState(ps){
  var isViewed=false;
  var dstIndex;
  var tempPs;
  for(dstIndex=0;dstIndex<ps.history.length;dstIndex++){
    tempPs=ps.history[dstIndex];
    if(ps.chineses==tempPs.chineses&&ps.chap==tempPs.chap){
        isViewed=true;
        for(var i=dstIndex+1;i<ps.history.length;i++)
            ps.history[i-1]=ps.history[i];
        ps.history[ps.history.length-1]=tempPs;
        break;
    }
  }
  
  
  if(isViewed==false)
    ps.history.push({chineses:ps.chineses,chap:ps.chap});
  //console.dir(ps);
  localStorage.setItem("fhlPageState",JSON.stringify(pageState));
}
function pageStateInit(){
    pageState={
      engs:"Gen",chineses:"创",chap:1,sec:1,version:["unv"],strong:0,
      gb:0,book:3,N:0,k:"",cname:["和合本"],realTimePopUp:0,titleId:"fhlInfoComment",
      history:[{chineses:"创",chap:1}], fontSize: 12, commentBackgroundChap:1, commentBackgroundSec:1,
      leftBtmWinShow:true,searchTitleMsg:"",audio:0,swVer:currentSWVer
    };
}

function windowAdjust(){
    if(!document.mozFullScreen && !document.webkitIsFullScreen){
        $("#mainWindow").css({top: "40px"});
        //$("#bookSelectPopUp").css({top: "100px"});
    }

    /* for leftWindow height */
    var height = $(window).height()-$('#fhlTopMenu').height()-12;
    if(document.mozFullScreen || document.webkitIsFullScreen)
        height+=$('#fhlTopMenu').height();
    $('#fhlLeftWindow').css({height: height+'px'});

    $('#viewHistory').css({top: $('#fhlLeftWindow').height()-$('#viewHistory').height()-12+'px'});
    $('#versionSelect').css({height: $('#fhlLeftWindow').height()-$('#settings').height()-$('#viewHistory').height()-36+'px'});

    /* for MidWindow and fhlInfo height */

    //var mainWindow = document.querySelector("#mainWindow");
    height = $(window).height()-$('#fhlTopMenu').height()-$('#fhlToolBar').height()-36-1;
    if(document.mozFullScreen || document.webkitIsFullScreen)
        height+=$('#fhlTopMenu').height();

    $('#fhlMidWindow').css({
        height: height + 'px'
    });

    $('#fhlInfo').css({
        height: height + 'px'
    });

    /* for MidBottomWindow height */

    if($("#fhlMidBottomWindowControl").hasClass('selected'))
        height-=($("#fhlMidBottomWindow").height()+12);

    $('#fhlLecture').css({
        height: height + 'px'
    });
    $('#fhlMidBottomWindow').css({'top': height +12+ 'px'});

    /* for fhlMidWinow width */

    var width=$(window).width()-24;

    if($("#fhlLeftWindowControl").hasClass('selected'))
        width-=($("#fhlLeftWindow").width()+12);

    if($('#fhlInfoWindowControl').hasClass('selected'))
        width-=($("#fhlInfo").width()+12);

    $("#fhlMidWindow").css({
      'width': width+'px'
    });


    /* for fhlInfo width */

    var fhlInfoLeft = 10;
    if($('#fhlInfoWindowControl').hasClass('selected')){
        $('#fhlInfo').css({
            'left': $(window).width()-$('#fhlInfo').width()-12+'px'
        });
    }
    else{
        $('#fhlInfo').css({
            'left': $(window).width() + 15 + 'px'
        });
    }
    
    /*  */
    $('#lecMain').scrollTop($('#lecMain').scrollTop()+$('#lecMain').find('.lec.selected').position().top-80);
}

$(window).resize(function(e) {
    if (e.target == window){
        windowAdjust();
    }
    
});

$(function(){
  //fhlTopMenu.init(pageState);
  //fhlTopMenu.render(pageState);
  //Check cache
  if(localStorage.getItem("fhlPageState")!=null){
    //console.log(localStorage.getItem("fhlPageState"));
    var tmp=JSON.parse(localStorage.getItem("fhlPageState"));
    if(tmp.swVer!=currentSWVer){
      pageStateInit();
      setPageState(pageState);
    }else{
      pageState=tmp;
      setPageState(pageState);
    }
  }else{
    pageStateInit();
    setPageState(pageState);
  }
  fhlToolBar.init(pageState);
  fhlLeftWindow.init(pageState);
  fhlMidWindow.init(pageState);
  fhlInfo.init(pageState);
  registerEvents(pageState);
});

var urlJSON="https://bkbible.fhl.net/json/";
var chineseNumber=new Array( "零", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十",
                            "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十",
                            "二十一", "二十二", "二十三", "二十四", "二十五", "二十六", "二十七", "二十八", "二十九", "三十",
                            "三十一", "三十二", "三十三", "三十四", "三十五", "三十六", "三十七", "三十八", "三十九", "四十",
                            "四十一", "四十二", "四十三", "四十四", "四十五", "四十六", "四十七", "四十八", "四十九", "五十",
                            "五十一", "五十二", "五十三", "五十四", "五十五", "五十六", "五十七", "五十八", "五十九", "六十",
                            "六十一", "六十二", "六十三", "六十四", "六十五", "六十六", "六十七", "六十八", "六十九", "七十",
                            "七十一", "七十二", "七十三", "七十四", "七十五", "七十六", "七十七", "七十八", "七十九", "八十",
                            "八十一", "八十二", "八十三", "八十四", "八十五", "八十六", "八十七", "八十八", "八十九", "九十",
                            "九十一", "九十二", "九十三", "九十四", "九十五", "九十六", "九十七", "九十八", "九十九", "一百",
                            "一百零一", "一百零二", "一百零三", "一百零四", "一百零五", "一百零六", "一百零七", "一百零八", "一百零九", "一百一十",
                            "一百一十一", "一百一十二", "一百一十三", "一百一十四", "一百一十五", "一百一十六", "一百一十七", "一百一十八", "一百一十九", "一百二十",
                            "一百二十一", "一百二十二", "一百二十三", "一百二十四", "一百二十五", "一百二十六", "一百二十七", "一百二十八", "一百二十九", "一百三十",
                            "一百三十一", "一百三十二", "一百三十三", "一百三十四", "一百三十五", "一百三十六", "一百三十七", "一百三十八", "一百三十九", "一百四十",
                            "一百四十一", "一百四十二", "一百四十三", "一百四十四", "一百四十五", "一百四十六", "一百四十七", "一百四十八", "一百四十九", "一百五十");

var book=new Array( "创","出","利","民","申","书","士","得","撒上","撒下","王上","王下",
                    "代上","代下","拉","尼","斯","伯","诗","箴","传","歌","赛","耶",
                    "哀","结","但","何","珥","摩","俄","拿","弥","鸿","哈","番","该","亚","玛",
                    "太","可","路","约","徒","罗","林前","林后","加","弗","腓","西",
                    "帖前","帖后","提前","提后","多","门","来","雅",
                    "彼前","彼后","约一","约二","约三","犹","启");

var bookGB=new Array( "?","出","利","民","申","?","士","得","撒上","撒下","王上","王下",
                      "代上","代下","拉","尼","斯","伯","?","箴","?","歌","?","耶",
                      "哀","?","但","何","珥","摩","俄","拿","?","?","哈","番","?","?","?",
                      "太","可","路","?","徒","?","林前","林后","加","弗","腓","西",
                      "帖前","帖后","提前","提后","多","?","?","雅",
                      "彼前","彼后","?一","?二","?三","?","?");

var bookFullName=new Array( "创世记","出埃及记","利未记","民数记","申命记","约书亚记","士师记",
                            "路得记","撒母耳记上","撒母耳记下","列王纪上","列王纪下",
                            "历代志上","历代志下","以斯拉记","尼希米记","以斯帖记","约伯记",
                            "诗篇","箴言","传道书","雅歌","以赛亚书","耶利米书",
                            "耶利米哀歌","以西结书","但以理书","何西阿书","约珥书","阿摩司书",
                            "俄巴底亚书","约拿书","弥迦书","那鸿书","哈巴谷书",
                            "西番雅书","哈该书","撒迦利亚书","玛拉基书",
                            "马太福音","马可福音","路加福音","约翰福音","使徒行传","罗马书",
                            "哥林多前书","哥林多后书","加拉太书","以弗所书","腓立比书","歌罗西书",
                            "帖撒罗尼迦前书","帖撒罗尼迦后书","提摩太前书","提摩太后书",
                            "提多书","腓利门书","希伯来书","雅各书",
                            "彼得前书","彼得后书","约翰壹书","约翰贰书","约翰参书","犹大书","启示录");
var bookChapters=new Array( 50,40,27,36,34,24,21,4,31,24,22,25,
                            29,36,10,13,10,42,150,31,12,8,66,52,
                            5,48,12,14,3,9,1,4,7,3,3,3,2,14,4,
                            28,16,24,21,28,16,16,13,6,6,4,4,
                            5,3,6,4,3,1,13,5,
                            5,3,5,1,1,1,22
                            );
var bookEng=new Array("Gen","Ex","Lev","Num","Deut","Josh","Judg","Ruth","1 Sam","2 Sam",
                "1 Kin","2 Kin","1 Chr","2 Chr","Ezra","Neh","Esth","Job","Ps","Prov",
                "Eccl","Song","Is","Jer","Lam","Ezek","Dan","Hos","Joel","Amos","Obad",
                "Jon","Mic","Nah","Hab","Zeph","Hag","Zech","Mal",
                "Matt","Mark","Luke","John","Acts","Rom","1 Cor","2 Cor","Gal","Eph",
                "Phil","Col","1 Thess","2 Thess","1 Tim","2 Tim","Titus","Philem",
                "Heb","James","1 Pet","2 Pet","1 John","2 John","3 John","Jude","Rev");
function getAjaxUrl(func,ps,idx){
  var paramArr=new Array("engs","chineses","chap","sec","version",
                          "strong","gb","book","N","k");
  var urlParams={
    sc:[0,2,3,6,7],
    qb:[1,2,4,5,6],
    qp:[0,2,3,6],
    sd:[6,8,9]
  };
  var getFullAjaxUrl=function(func,ps,idx){
    var ret=urlJSON+func+".php?";
    for(var i=0;i<urlParams[func].length;i++){
      if(paramArr[urlParams[func][i]]=="version"){
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]][idx]);
        ret+="&";
      }else{
        ret+=paramArr[urlParams[func][i]];
        ret+="=";
        ret+=encodeURIComponent(ps[paramArr[urlParams[func][i]]]);
        ret+="&";
      }
    };

    ret=ret.substring(0,ret.length-1);
    //console.log(ret);
    return ret;
  }
  return getFullAjaxUrl(func,ps,idx);
}

function getBookFunc(func,bookName){
  var i;
  for(i=0;i<book.length;i++)
    if(book[i]==bookName)break;
  var ret;
  switch(func){
    case "index":
      ret=i;
      break;
    case "indexByEngs":
      for(i=0;i<bookEng.length;i++)
        if(bookEng[i]==bookName)break;
      ret=i;
      break;
    case "bookFullName":
      ret=bookFullName[i];
      break;
    case "bookChapters":
      ret=bookChapters[i];
      break;
    case "bookEng":
      ret=bookEng[i];
      break;
    default:
      ret="failed";
      break;
  }
  return ret;
}

function requestFullscreen(){
    $("#mainWindow").css({top: "0px"});
    //$("#bookSelectPopUp").css({top: "0px"});
    var mainWindow = document.querySelector("#mainWindow");
    if ((document.fullScreenElement !== undefined && document.fullScreenElement === null) || (document.msFullscreenElement !== undefined && document.msFullscreenElement === null) || (document.mozFullScreen !== undefined && !document.mozFullScreen) || (document.webkitIsFullScreen !== undefined && !document.webkitIsFullScreen)) {
        if (mainWindow.requestFullScreen) {
            mainWindow.requestFullScreen();
        } else if (mainWindow.mozRequestFullScreen) {
            mainWindow.mozRequestFullScreen();
        } else if (mainWindow.webkitRequestFullScreen) {
            mainWindow.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
        } else if (mainWindow.msRequestFullscreen) {
            mainWindow.msRequestFullscreen();
        }
    }
}

function registerEvents(ps){
    /* scrolling register */
    /*setTimeout(function() {
        $('div').scroll(function() {
            $(this).addClass('scrolling');
            clearTimeout( $.data( this, "scrollCheck" ) );
            $.data( this, "scrollCheck", setTimeout(function() {
                $('div').removeClass('scrolling');
            }, 350) );
        });
    }, 2000);*///等到其他function 跑完 (backup 用)

    /*shortcut register*/
    $(document).bind('keydown', 'alt+shift+f', function(){
        $('[data-ic-class="search-trigger"]').trigger("click");
        setTimeout(function() {$('[data-ic-class="search-clear"]').trigger("click");}, 1);
    });
    $(document).bind('keydown', 'esc', function(){
        $('#helpingPopUp').css({
            'visibility': 'hidden',
            'opacity': '0'
        });
    });
    $(document).keyup(function(e) {
        if (e.keyCode == 27) { // escape key maps to keycode `27`
            // exit from fullscreen
            windowAdjust();
            $('#fullscreenControl').removeClass('selected');
        }
    });
    $(document).bind('keydown', 'alt+shift+l', function(){
        //document.documentElement.webkitRequestFullScreen();
        requestFullscreen();
        $('#fullscreenControl').addClass('selected');
    });
    $(document).bind('keydown', 'alt+shift+s', function(){
        var idx=getBookFunc("index",ps.chineses);
        var position=$('#bookSelect').position();
        position.left='40%';//$('#bookSelect').position().left;
        position.top='20%';//$('#bookSelect').position().top+$('#bookSelect').height()+10;
        bookSelectChapter.init(ps,$('#bookSelectChapter'),idx,position);
        bookSelectChapter.registerEvents(ps);
        //isBookSelectChapterPopUp=true;
        //bookselectchapter.dom.hide();
        bookSelectChapter.dom.show();
        //alert(pageState.chineses);
    });
    $(document).bind('keydown', 'alt+shift+z', function(){
        $('#fhlLeftWindowControl').trigger("click");
    });
    $(document).bind('keydown', 'alt+shift+x', function(){
        $('#fhlMidBottomWindowControl').trigger("click");
    });
    $(document).bind('keydown', 'alt+shift+c', function(){
        $('#fhlInfoWindowControl').trigger("click");
    });
    $(document).bind('keydown', 'alt+shift+/', function(){
        $('#help').trigger("click");
    });
    $(document).bind('keydown', 'ctrl+c', function(){
        var copyTextarea = document.querySelector('#test');
        //copyTextarea.style.backgroundColor = "red";
        copyTextarea.select();
    });

    /*in search input*/
    $('[data-ic-class="search-input"]').bind('keydown', 'alt+shift+f', function(){
        $('[data-ic-class="search-trigger"]').trigger("click");
        setTimeout(function() {$('[data-ic-class="search-clear"]').trigger("click")}, 1);
    });
    $('[data-ic-class="search-input"]').bind('keydown', 'esc', function(){
        $('[data-ic-class="search-input"]').val('');
        $('[data-ic-class="search-trigger"]').removeClass('active');
    });
    $('[data-ic-class="search-input"]').bind('keydown', 'return', function(){
        $('.searchBtn').trigger("click");
    });
}

/***** Start of fhlToolBar *****/

var fhlToolBar={
    init:function(ps){
        //this.registerEvents();
        help.init(ps,$('#help'));
        windowControl.init(ps,$('#windowControl'));
        windowControl.registerEvents(ps);
        bookSelect.init(ps,$('#bookSelect'));
        searchTool.init(ps,$('#searchTool'));
        searchTool.registerEvents(ps);
    }
};
var help={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    helpingPopUp.init(ps, $('#helpingPopUp'));
  },
  registerEvents:function(ps){
    this.dom.on('click', function(){
        $('#helpingPopUp').css({
            'visibility': 'visible',
            'opacity': '1'
        });
    });
  },
  render:function(ps,dom){
      var html="";
      html+='?';
      dom.html(html);
      this.registerEvents(ps);
  }
};

var helpingPopUp={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
      $('#helpCloseButton').click(function(){
          $('#helpingPopUp').css({
            'visibility': 'hidden',
            'opacity': '0'
        });
      });
  },
  render:function(ps,dom){
      var html="";
      html+='<div><div id="helpCloseButton"><i class="fa fa-times"></i></div><ul>\
                <li>Alt + Shift + F: 搜寻</li>\
                <li>Alt + Shift + S: 快速选章</li>\
                <li>Alt + Shift + L: 全萤幕</li>\
                <li>Alt + Shift + Z: 设定视窗开关</li>\
                <li>Alt + Shift + X: 搜寻视窗开关</li>\
                <li>Alt + Shift + C: 辅助视窗开关</li>\
                <li>Alt + Shift + /: 帮助</li>\
                <li>Esc: 跳出</li></ul></div>';
      $('#helpingPopUpInside').html(html);
      this.registerEvents(ps);
  }
}

var windowControl={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    this.registerEvents(ps);
  },
  registerEvents:function(ps){
      $('#windowControlIcon').click(function(e){
          if($(this).hasClass('selected')){
              var that=$(this);
              that.animate({left: '0px'});
              $("#windowControl").animate({width: '30px'}, function(){
                  that.removeClass('selected');
              });
              $("#windowControlButtons").animate({opacity: 0}, 100);
          }
          else{
              var that=$(this);
              that.animate({left: '20px'});
              $("#windowControl").animate({width: '350px'}, function(){
                  that.addClass('selected');
              });
              $("#windowControlButtons").animate({opacity: 1}, 800);
          }
          e.stopPropagation();
      });
      $(document).click(function(){
          if($('#windowControlIcon').hasClass('selected')){
            //$('#windowControlIcon').trigger( "click" );
          }
      });
      $('#fhlLeftWindowControl').click(function(){
          if($(this).hasClass('selected')){
              var that=$(this);
              var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
              $("#fhlLeftWindow").animate({left: -fhlLeftWindowWidth-15 + 'px'});
              $("#fhlToolBar").animate({left: '12px'});
              $("#fhlMidWindow").animate({left: '12px', width: $("#fhlMidWindow").width() + fhlLeftWindowWidth + 12 + 'px'}, function(){
                  that.removeClass('selected');
              });
          }
          else{
              var that=$(this);
              var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
              $("#fhlLeftWindow").animate({left: '12px'});
              $("#fhlToolBar").animate({left: fhlLeftWindowWidth + 24 + 'px'});
              $("#fhlMidWindow").animate({left: fhlLeftWindowWidth+12+12 + 'px', width: $("#fhlMidWindow").width() - fhlLeftWindowWidth -12 + 'px'}, function(){
                  that.addClass('selected');
              });
          }
      });
      $('#fhlMidBottomWindowControl').click(function(){
          if($(this).hasClass('selected')){
              var that=$(this);
              var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
              $("#fhlMidBottomWindow").animate({top: $('#fhlMidWindow').height()+15+'px', bottom: -fhlMidBottomWindowHeight-15 + 'px'});
              $("#fhlLecture").animate({bottom: '0px', height: $("#fhlLecture").height() + fhlMidBottomWindowHeight+12 + 'px'}, function(){
                  that.removeClass('selected');
              });
          }
          else{
              var that=$(this);
              var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
              $("#fhlMidBottomWindow").animate({top: $('#fhlMidWindow').height()-fhlMidBottomWindowHeight+'px', bottom: '0px'});
              $("#fhlLecture").animate({bottom: fhlMidBottomWindowHeight + 'px', height: $("#fhlLecture").height() - fhlMidBottomWindowHeight - 12 + 'px'}, function(){
                  that.addClass('selected');
              });
          }
      });
      $('#fhlInfoWindowControl').click(function(){
          if($(this).hasClass('selected')){
              var that=$(this);
              var fhlInfoWidth = $("#fhlInfo").width();
              $("#fhlInfo").animate({left: $(window).width() + 15 + 'px', right: -fhlInfoWidth-15 + 'px', width: fhlInfoWidth});
              $("#fhlMidWindow").animate({right: '12px', width: $("#fhlMidWindow").width() + fhlInfoWidth + 12 + 'px'}, function(){
                  that.removeClass('selected');
              });
          }
          else{
              var that=$(this);
              var fhlInfoWidth = $("#fhlInfo").width();
              $("#fhlInfo").animate({left: $(window).width()-fhlInfoWidth-12 + 'px', right: '12px'});
              $("#fhlMidWindow").animate({right: fhlInfoWidth + 'px', width: $("#fhlMidWindow").width() - fhlInfoWidth - 12 + 'px'}, function(){
                  that.addClass('selected');
              });
          }
      });
      $('#fullscreenControl').click(function(){
          if($(this).hasClass('selected')){
              var that = $(this);
              setTimeout(function(){that.removeClass('selected');}, 1);
          }
          else{
              var that = $(this);
              requestFullscreen();
              setTimeout(function(){that.addClass('selected');}, 1);
          }
      });
      $('#windowControl').click(function(e){
          e.stopPropagation();
      });
  },
  render:function(ps,dom){
    var html="<i id='windowControlIcon' class='fa fa-tv fa-fw selected'></i><div id='windowControlButtons'><span id='fhlLeftWindowControl' class='selected' ><i class='fa fa-wrench fa-fw'></i></span><span id='fhlMidBottomWindowControl'><i class='fa fa-search-plus fa-fw'></i></span><span id='fhlInfoWindowControl' class='selected'><i class='fa fa-file-text-o fa-fw'></i></span><space style='margin: 0px 10px; cursor: default; color: #D0D0D0;'>|</space><span id='fullscreenControl'><i class='fa fa-arrows-alt fa-fw'></i></span></div>";
    dom.html(html);
  }
};

var bookSelect={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
    bookSelectPopUp.init(ps,$('#bookSelectPopUp'));
    bookSelectPopUp.registerEvents(ps);
  },
  registerEvents:function(ps){
    var that=this;
    $('#bookSelect').unbind().click(function(e){// 加上unbind() 让创世记第二节之后的dropdown不会自动消失
        if(bookSelectPopUp.dom.is(":visible")){
            bookSelectPopUp.dom.fadeOut('0.2');
            setTimeout(function(){
                bookSelect.dom.css({'color': '#D0D0D0'});
            }, 200);
        }
        else{
            bookSelectPopUp.dom.fadeIn('0.2');
            bookSelect.dom.css({'color': '#00A0FF'});
        }
        e.stopPropagation();
    });
    $('#bookSelectPopUp').click(function() {
        bookSelectPopUp.dom.fadeOut('0.2');
        setTimeout(function(){ bookSelect.dom.css({'color': '#D0D0D0'}); }, 200);
    });
    $(document).click(function() {
        bookSelectPopUp.dom.fadeOut('0.2');
        setTimeout(function(){ bookSelect.dom.css({'color': '#D0D0D0'}); }, 200);
    });
    $('#bookSelectName').click(function(e) {
        e.stopPropagation();
    });
    $('#bookSelect').mouseenter(function(){
        if(!bookSelectPopUp.dom.is(":visible")){
            bookSelect.dom.css({'color': '#00A0FF'});
        }
    });
    $('#bookSelect').mouseleave(function(){
        if(!bookSelectPopUp.dom.is(":visible")){
            bookSelect.dom.css({'color': '#D0D0D0'});
        }
    });
  },
  render:function(ps,dom){
      var bookName=getBookFunc("bookFullName",ps.chineses);
      var html="";
      if(bookName!="诗篇")
          html=bookName+"： 第"+chineseNumber[ps.chap]+"章";
      else
          html=bookName+"： 第"+chineseNumber[ps.chap]+"篇";
      html+='&nbsp;&#9660;';
      dom.html(html);
      this.registerEvents(ps);
  }
};

var bookSelectPopUp={
  init:function(ps,dom){
    this.dom=dom;
    bookSelectName.init(ps,$('#bookSelectName'));
    bookSelectName.registerEvents(ps);
    this.dom.hide();
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.click(function(e) {
        e.stopPropagation();
    });
  }
};

var bookSelectName={
  init:function(ps,dom){
    this.dom=dom;
    this.render(ps,this.dom);
  },
  registerEvents:function(ps){
    var that=this.dom;
    var isBookSelectChapterPopUp=false;

    this.dom.find('li li').click(function(){
        var that = $(this);
        var selectedColumnIndex = $(this).parents('li').index();
        //var previousColumnIndex = bookSelectName.dom.find('#old-testament>ul>li.selected').index();
        //var previousRowIndex = bookSelectName.dom.find('li li.selected').index();
        //console.log(previousColumnIndex);
        bookSelectName.dom.find('#old-testament>ul>li').removeClass('selected');
        
        if(bookSelectName.dom.find('li li.selected').attr('chineses')==$(this).attr('chineses'))
            $('.testaments>ul>li').animate( { left: '0px' }, { queue:false, duration:300 });
        else
            $(this).parents('li').addClass('selected');
        setTimeout(function(){
            if(isBookSelectChapterPopUp===true && that.hasClass('selected')){
                isBookSelectChapterPopUp=true;
                bookSelectName.dom.find('li li').removeClass('selected');
                bookSelectChapter.dom.hide();
            }
            else{
                $('#old-testament>ul>li:lt(' + selectedColumnIndex + ')').animate( { left: '-75px' }, { queue:false, duration:200 });
                $('#old-testament>ul>li:eq(' + selectedColumnIndex + ')').animate( { left: '-75px' }, { queue:false, duration:200 });
                $('#old-testament>ul>li:gt(' + selectedColumnIndex + ')').animate( { left: '75px' }, { queue:false, duration:200 });
                var idx=getBookFunc("index",that.attr('chineses'));
                var isIE11 = !!navigator.userAgent.match(/Trident.*rv\:11\./);
                if($.browser.msie || isIE11) {
                    var position=that.offset();
                    position.left=$('#old-testament').offset().left+128*(selectedColumnIndex)+50;
                    position.top=$('#old-testament').offset().top+30;
                    bookSelectChapter.init(ps,$('#bookSelectChapter'),idx,position);
                }
                else{
                    var position=that.offset();
                    position.left=$('#old-testament').position().left+that.position().left+128*(selectedColumnIndex)+40;
                    position.top=$('#old-testament').position().top+25;
                    bookSelectChapter.init(ps,$('#bookSelectChapter'),idx,position);
                }
                bookSelectChapter.registerEvents(ps);
                bookSelectName.dom.find('li li').removeClass('selected');
                that.addClass('selected');
                isBookSelectChapterPopUp=true;
                bookSelectChapter.dom.show();
            }
        }, 1);
    });
  },
  render:function(ps,dom){
      var html="<div id='bookSelectTitle'>经卷选择</div><div id='bookSelectChapter'></div>";
      html+="<div id='old-testament' class='testaments'><ul><li></li><li><span class='bookClass'>摩西五经</span><ul>";
      for(var i=0;i<5;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul><span class='bookClass'>旧约历史书</span><ul>";
      for(var i=5;i<17;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li><span class='bookClass'>诗歌智慧书</span><ul>";
      for(var i=17;i<22;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul><span class='bookClass'>大先知书</span><ul>";
      for(var i=22;i<27;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li><span class='bookClass'>小先知书</span><ul>";
      for(var i=27;i<39;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li><span class='bookClass'>福音书</span><ul>";
      for(var i=39;i<43;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul><span class='bookClass'>新约历史书</span><ul>";
      for(var i=43;i<44;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li><span class='bookClass'>保罗书信</span><ul>";
      for(var i=44;i<57;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li><span class='bookClass'>其他书信</span><ul>";
      for(var i=57;i<65;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul><span class='bookClass'>预言书</span><ul>";
      for(var i=65;i<66;i++)
          html+="<li><span>"+bookFullName[i]+"<i class='fa fa-angle-right fa-fw'></i></span></li>";
      html+="</ul></li><li></li></ul></div>";

      dom.html(html);

      for(var i=0;i<bookFullName.length;i++){
          dom.find('li li:eq('+i+')').attr('chineses',book[i]);
      }
    /*for(var i=0;i<bookFullName.length;i++){
      dom.find('li:eq('+i+')').attr('chineses',book[i]);
    }*/
  }
};

var bookSelectChapter={
  init:function(ps,dom,idx,position){
    this.dom=dom;
    this.idx=idx;
    this.dom.css({
        'position': 'fixed',
        'left':position.left,
        'top':position.top,
        'box-shadow':'inset 0px 0px 5px 1px rgba(0,0,0,0.75)',
    });
    this.render(ps,this.dom,this.idx);
  },
  registerEvents:function(ps){
    var that=this;
    this.dom.find('li').click(function(){
      ps.chineses=book[that.idx];
      ps.engs=bookEng[that.idx];
      ps.chap=parseInt($(this).attr('chap'));
      ps.sec=1;
      setPageState(ps);
      bookSelect.render(ps,bookSelect.dom);
      fhlLecture.render(ps,fhlLecture.dom);
      viewHistory.render(ps,viewHistory.dom);
      fhlInfo.render(ps);
      bookSelectPopUp.dom.hide();
      //bookselectchapter.dom.hide();
      bookSelect.dom.css({'color': '#FFFFFF'});
    });
    $(document).click(function() {
        //bookselectchapter.dom.hide('0.2');
    });
    this.dom.mouseenter(function(){
        clearTimeout($.data( $('#bookSelectChapter')[0], "bookSelectChapterAutoCloseTimeout" ));
    });
  },
  render:function(ps,dom,idx){
    var numOfChapters=bookChapters[idx];
    var html="<div><ul>";
    for(var i=1;i<=numOfChapters;i++){
      html+="<li>"+i+"</li>";
    }
    html+="</ul></div>";
    dom.html(html);
    for(var i=0;i<numOfChapters;i++){
      dom.find('li:eq('+i+')').attr('chap',i+1);
    }
  }
};


/***** End of fhlToolBar *****/

/***** Start of fhlLeftWindow *****/

var fhlLeftWindow={
  init:function(ps){
      settings.init(ps,$('#settings'));
      settings.registerEvents(ps);
      versionSelect.init(ps,$('#versionSelect'));
      //versionSelect.registerEvents(ps);
      viewHistory.init(ps,$('#viewHistory'));
      this.registerEvents();
  },
  registerEvents:function(){
      $('#fhlLeftWindow').resizable({
        handles: 'e',
        maxWidth: 300,
        minWidth: 170,
        resize: function(event, ui){
          var currentWidth = ui.size.width;
          var fhlMidWindowWidth;
            if($('#fhlInfoWindowControl').hasClass('selected'))
                fhlMidWindowWidth=$(window).width()-$("#fhlInfo").width()-currentWidth;
            else
                fhlMidWindowWidth=$(window).width()-currentWidth+12;
          $("#fhlMidWindow").css({
              'width': fhlMidWindowWidth-12*4+'px',
              'left': currentWidth+12+12+'px'
          });
          $('#fhlToolBar').css({
              //'width': $(window).width()-$("#fhlLeftWindow").width()-36+'px',
              'left': currentWidth+12+12+'px',
              'right': '12px'
          });
        }
      });
      $('.ui-resizable-handle.ui-resizable-e').html('<span>&#9776;</span>');
  }
};

var settings={
    init:function(ps,dom){
        this.dom=dom;
        this.render(ps,this.dom);
        snSelect.init(ps,$('#snSelect'));
        snSelect.registerEvents(ps);
        realTimePopUpSelect.init(ps,$('#realTimePopUpSelect'));
        realTimePopUpSelect.registerEvents(ps);
        gbSelect.init(ps,$('#gbSelect'));
        gbSelect.registerEvents(ps);
        mapTool.init(ps,$('#mapTool'));
        mapTool.registerEvents(ps);
        imageTool.init(ps,$('#imageTool'));
        imageTool.registerEvents(ps);
        fontSizeTool.init(ps,$('#fontSizeTool'));
        fontSizeTool.registerEvents(ps);
    },
    registerEvents:function(ps){
        $('#settings p')
            .on('click', function(){
                var html =  $(this).html() == "